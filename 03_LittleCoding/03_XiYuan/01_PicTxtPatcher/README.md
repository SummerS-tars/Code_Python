# 图片与参数文件匹配处理脚本使用说明

## 概述

这个脚本用于处理项目中图片(.png)与对应参数文件(.txt)的匹配，根据文件命名规则进行自动匹配并重新组织文件结构。

## 文件说明

- `pic_txt_patcher.py` - 主要处理脚本
- `test_pic_txt_patcher.py` - 测试脚本和演示数据生成器
- `requirements.md` - 详细需求文档
- `README.md` - 这个使用说明文件

## 功能特性

### 主要功能

1. **文件名解析**: 自动解析两种图片文件命名格式
   - `tag_time-tag_train/val.png` (如: `Ada_2024_3_8_20_45-30_train.png`)
   - `time_hash-tag_train/val.png` (如: `2024_3_18_17_19_e8ba0101cbc74242b48af70a57dafdf5-5_train.png`)

2. **智能匹配**: 根据图片文件名自动查找对应的参数文件(.txt)

3. **文件结构重组**: 创建新的目录结构

   ```text
   class_name/
   ├── pic/        # 匹配成功的图片文件
   ├── txt/        # 对应的参数文件
   └── unmatched/  # 无法匹配的图片文件
   ```

4. **统计报告**: 提供详细的处理统计信息和日志记录

5. **异常处理**: 识别和处理孤儿文件（没有对应图片的txt文件）

## 使用方法

### 1. 基本使用

```bash
python pic_txt_patcher.py
```

**重要**: 使用前需要修改 `pic_txt_patcher.py` 中的 `base_path` 变量，设置为你的 `class_all` 目录的实际路径。

```python
# 在main函数中修改这行
base_path = r"E:\_WorkingTemp\XiYuanTotalProcess\class_all"  # 修改为你的实际路径
```

### 2. 创建测试数据

如果你想先测试脚本功能，可以创建演示数据：

```bash
python test_pic_txt_patcher.py
```

选择选项 2 来创建演示数据结构。

### 3. 运行单元测试

```bash
python test_pic_txt_patcher.py
```

选择选项 1 来运行单元测试验证功能。

## 目录结构要求

### 处理前的目录结构

```text
class_all/
├── class/
│   ├── Ada/
│   │   ├── Ada_2024_3_8_20_45-30_train.png
│   │   ├── Ada_2024_3_8_20_45-31_val.png
│   │   └── ...
│   └── Bob/
│       └── ...
├── class_unknown/
│   ├── class1_ikea/
│   │   ├── 2024_3_18_17_19_e8ba0101cbc74242b48af70a57dafdf5-5_train.png
│   │   └── ...
│   └── ...
└── labels/
    ├── train/
    │   ├── Ada_2024_3_8_20_45-30.txt
    │   ├── 2024_3_18_17_19_e8ba0101cbc74242b48af70a57dafdf5-5.txt
    │   └── ...
    └── val/
        ├── Ada_2024_3_8_20_45-31.txt
        └── ...
```

### 处理后的目录结构

```text
class_all/
├── class/
│   ├── Ada/
│   │   ├── pic/
│   │   │   ├── Ada_2024_3_8_20_45-30_train.png
│   │   │   └── Ada_2024_3_8_20_45-31_val.png
│   │   ├── txt/
│   │   │   ├── Ada_2024_3_8_20_45-30.txt
│   │   │   └── Ada_2024_3_8_20_45-31.txt
│   │   └── unmatched/  # 无法匹配的图片
│   └── Bob/
│       ├── pic/
│       ├── txt/
│       └── unmatched/
├── class_unknown/
│   └── ... (同样的结构)
└── labels/  # 保持原有结构，孤儿txt文件留在这里
    ├── train/
    └── val/
```

## 输出和日志

### 控制台输出

脚本运行时会显示：

- 处理进度信息
- 匹配成功/失败的文件
- 最终统计摘要

### 日志文件

自动生成日志文件：`pic_txt_patcher_YYYYMMDD_HHMMSS.log`

包含详细的处理信息：

- 所有文件的处理状态
- 错误和警告信息
- 完整的统计数据

### 统计信息

处理完成后会显示：

- 处理的类别数量
- 总图片数量
- 成功匹配的图片数量
- 无法匹配的图片数量
- 孤儿txt文件数量
- 匹配成功率

## 注意事项

1. **备份数据**: 运行脚本前建议备份原始数据，脚本会移动文件

2. **路径设置**: 确保 `base_path` 设置正确，指向包含 `class`、`class_unknown` 和 `labels` 目录的父目录

3. **权限检查**: 确保脚本有读写目标目录的权限

4. **文件名格式**: 脚本依赖特定的文件命名格式，确保图片文件名符合规范

5. **大数据量**: 对于大量文件，处理可能需要一些时间，请耐心等待

## 故障排除

### 常见问题

1. **找不到base_path**: 检查路径是否正确，使用绝对路径
2. **权限错误**: 确保有足够的文件系统权限
3. **文件名解析失败**: 检查图片文件名是否符合预期格式
4. **匹配率低**: 检查labels目录下的txt文件是否完整

### 调试技巧

1. 使用测试数据先验证功能
2. 查看生成的日志文件获取详细信息
3. 检查统计摘要了解处理结果

## 扩展和定制

### 修改文件名解析规则

如果需要支持其他文件命名格式，修改 `extract_txt_filename_from_image` 方法。

### 添加新的处理逻辑

可以在 `process_class_directory` 方法中添加自定义的处理逻辑。

### 自定义统计信息

在 `stats` 字典中添加新的统计项目。

## 技术细节

- **Python版本**: 3.6+
- **依赖**: 仅使用Python标准库
- **文件操作**: 使用 `shutil` 和 `pathlib`
- **日志**: 使用 `logging` 模块
- **测试**: 使用 `unittest` 框架
