# SortCheck 脚本使用说明

该脚本用于检查并（可选）修复图片文件名中 `class` 与 `duplicate` 序号的连续性。

## 支持的文件名格式

```text
任意前缀_train_CLASS_DUP.ext
任意前缀_val_CLASS_DUP.ext
```
 
例如：

```text
Ada_2024_3_8_20_45-30_train_2_3.png
```
脚本只关心末尾结构：`_train|val_<class>_<duplicate>`。

## 规则

 
1. class 需要从 1 开始连续；若中间跳号，会将后续 class 前移补齐（统一重映射）。
2. duplicate 在同一 class 内需从 1 开始连续；
   - 缺失：自动前移补齐。
   - 重复：仅报告，不自动修复，需人工判断是否 class 标错或 duplicate 重复。
 

## 运行方式

 
默认 dry-run（仅报告不修改）。

```bash
python sortcheck.py -d <目录路径>
```

执行实际重命名：

```bash
python sortcheck.py -d <目录路径> --apply
```

显示未匹配文件等详细信息：

```bash
python sortcheck.py -d <目录路径> --verbose
```

### 递归处理多类别目录（Extra Requirements）

若你的目录结构如下（示例）：

```text
.../class_all
├──class
│  ├──Ada
│  │  ├──pic
│  │  ├──txt
│  │  └──unmatched
│  └──...
├──class_unknown
│  ├──class1_ikea
│  │  ├──pic
│  │  ├──txt
│  │  └──unmatched
│  └──...
└──labels
   ├──train
   └──val
```

可直接提供 `class_all` 根路径，脚本会递归查找其下所有名为 `pic` 的子目录并分别处理：

```bash
python sortcheck.py --class-all <class_all根路径>
```

同样支持 `--apply`、`--verbose` 与 `--interactive-dup` 组合使用：

```bash
python sortcheck.py --class-all <class_all根路径> --apply --verbose
```

## 输出说明

- Total files: 目录下全部文件数
- Parsed target files: 成功匹配命名模式的文件数
- Unmatched filenames: 不符合模式的文件（仅在 --verbose 下列出）
- Class mapping: 如果存在 class 跳号，显示 old->new 映射
- Duplicate conflicts: 存在重复 duplicate 的 (class, duplicate) 及涉及的文件。需人工处理。
- Duplicate reindex mappings: 对各 class 内 duplicate 重排的 old->new 映射
- Planned renames: dry-run 计划的重命名对

## 冲突避免策略

重命名采用两阶段：先改为临时名，再改为目标名，避免文件名直接覆盖。

## 常见问题

- 有重复 duplicate：脚本不会自动修复，请先区分是 class 错误还是 duplicate 重复，再手工更改后重新运行。
- 想只看报告：不要加 `--apply`。

## 后续可改进想法

- 支持递归子目录。
- 支持导出 CSV 报告。
- 提供交互式选择解决 duplicate 冲突。

---
Generated by assistant.

## PowerShell 交互脚本

已提供 `run_sortcheck.ps1` 支持在同一会话中多次对不同目录运行：

```powershell
pwsh ./run_sortcheck.ps1
```

进入后可输入：

| 指令     | 说明                                 |
| -------- | ------------------------------------ |
| 目录路径 | 对该目录执行一次检查（默认 dry-run） |
| apply    | 下次执行使用 --apply（只生效一次）   |
| verbose  | 切换 verbose 输出开关                |
| history  | 查看本会话已输入过的目录             |
| last     | 重新对上一次目录执行                 |
| clear    | 清屏                                 |
| help / h | 显示帮助                             |
| quit / q | 退出脚本                             |

可选参数：

```powershell
pwsh ./run_sortcheck.ps1 -PythonExe python -ScriptPath ./sortcheck.py
```

注意：`apply` 只对紧接着的一次执行生效，执行后恢复为 dry-run。
