# Pandas 学习 Improve

先前的学习中我们解除了单表分析处理  
现在我们开始多表处理  

目标：  

1. 多表关联（Merge/Join）：  
    类似于 SQL 中的 JOIN 操作  
    不硬编码连接逻辑  
2. 时间序列（Time Series）：  
    解释字符串时间  
    提取星期、小时等特征进行趋势分析  

## 核心概念

1. **Merge(表连接)**  
    - `pd.merge()`：类似SQL中的JOIN  
    - 参数：  
        - `how`：连接方式（'inner', 'left', 'right', 'outer'）  
            - inner：只保留左右表都匹配的记录（交集）。
            - left：保留左表全部，右表没有匹配的填 NaN。
            - right：保留右表全部，左表没有匹配的填 NaN。
            - outer：保留左右表所有记录，不匹配的填 NaN（并集）。
        - `on`：连接键  
        - `left_on`, `right_on`：分别指定左右表的连接键
    - 示例：  

        ```python
        merged_df = pd.merge(df1, df2, how='inner', on='key_column')
        ```

2. **DataTime(时间对象)**  
    - `pd.to_datetime()`：将str转为 **Timestamp** 对象  
    - `dt` 访问器：提取时间特征（年、月、日、小时、星期等）  
        可以直接获得人类可读的时间信息  
        - df['Date'].dt.day_name(): 获取星期几名称
        - df['Date'].dt.hour: 获取小时

## 实践部分

连锁咖啡店 (Day 2)  

### Step 1: Master Data

准备主数据  

### Step 2: 关联数据

老板发来了最新的产品价目表。我们要用这张表来修正我们之前的数据，并模拟一些跨越多天的数据以便分析。

这是 Pandas 中最强大的操作之一。我们将订单表 (df) 与产品表 (df_products) 链接起来。

- **思考**：我们希望保留所有的订单（左表 df 全保留），哪怕这个产品在价格表里找不到（虽然这里都找得到）。所以使用 how='left'。  

补充了错误模拟和数据验证的步骤。  
并添加了修复错误的代码。  

#### 最佳实践分析

可能经常遇到（价格、数量、时间录入错误、主数据变更等）。  
常见最佳实践：

- 以主数据为准：用 Base_Price 这类主数据作为“真值”，用规则纠正明细。
- 最小范围修复：用布尔掩码只更新异常行，避免全表重算。
- 派生列可再生：Total_Price 这类可计算字段，优先“按需重算”，不长期手工维护。
- 留痕与审计：修复前后保留差异（日志/备份/新列），便于追溯。
- 自动化校验：建立检查规则（如 Price 与 Base_Price 一致性），跑在管道里。

### Step 3: 时间序列处理

现在处理 Date 列。它目前只是字符串 (object)，无法进行数学运算或提取星期。  

### Step 4: 进阶分析

老板的问题升级了：“我们店是工作日生意好，还是周末生意好？哪类咖啡（分类）卖得最好？”  
